<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leo Xu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                tags: 'ams'
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                ignoreHtmlClass: 'tex2jax_ignore'
            },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link id="hljs-light" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css">
    <link id="hljs-dark" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github-dark.min.css" disabled>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #fafafa;
            --text-color: #1a1a1a;
            --text-muted-color: #666666;
            --primary-accent-color: #111111;
            --primary-accent-hover-color: #333333;
            --card-bg-color: rgba(235, 235, 235, 0.45);
            --card-border-color: rgba(200, 200, 200, 0.25);
            --header-bg-color: rgba(250, 250, 250, 0.72);
            --shadow-color-light: rgba(0,0,0,0.06);
            --shadow-color-medium: rgba(0,0,0,0.03);
            --sidebar-hover-bg: rgba(0,0,0,0.05);
            --sidebar-active-bg: rgba(0,0,0,0.08);
            --pre-bg-color: #f0f0f0;
            --pre-text-color: #1a1a1a;
            --glow-color: rgba(0, 0, 0, 0.5);
            --glow-color-intense: rgba(0, 0, 0, 0.8);
            --callout-note: #448aff;
            --callout-tip: #00c853;
            --callout-warning: #ff9100;
            --callout-danger: #ff1744;
            --callout-info: #448aff;
            --callout-example: #7c4dff;
        }

        html.dark {
            --bg-color: #0a0a0a;
            --text-color: #e8e8e8;
            --text-muted-color: #999999;
            --primary-accent-color: #f0f0f0;
            --primary-accent-hover-color: #cccccc;
            --card-bg-color: rgba(28, 28, 28, 0.55);
            --card-border-color: rgba(55, 55, 55, 0.35);
            --header-bg-color: rgba(12, 12, 12, 0.75);
            --shadow-color-light: rgba(255,255,255,0.04);
            --shadow-color-medium: rgba(255,255,255,0.02);
            --sidebar-hover-bg: rgba(255,255,255,0.06);
            --sidebar-active-bg: rgba(255,255,255,0.1);
            --pre-bg-color: #1a1a1a;
            --pre-text-color: #e8e8e8;
            --glow-color: rgba(255, 255, 255, 0.5);
            --glow-color-intense: rgba(255, 255, 255, 0.8);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            margin: 0;
        }

        /* ===== Frosted Glass ===== */
        .frosted-glass {
            background-color: var(--card-bg-color);
            backdrop-filter: blur(12px) saturate(120%);
            -webkit-backdrop-filter: blur(12px) saturate(120%);
            border: 1px solid var(--card-border-color);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px var(--shadow-color-light), 0 2px 4px -1px var(--shadow-color-medium);
        }

        .header-frosted {
            background-color: var(--header-bg-color);
            backdrop-filter: blur(14px) saturate(150%);
            -webkit-backdrop-filter: blur(14px) saturate(150%);
            box-shadow: 0 2px 10px var(--shadow-color-light);
        }

        /* ===== Header & Navigation ===== */
        nav.main-nav { position: relative; display: flex; }

        .tab {
            color: var(--text-muted-color);
            background: transparent;
            border: none;
            padding: 0.75rem 1.25rem;
            margin: 0 0.15rem;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            outline: none;
            position: relative;
            transition: color 0.3s ease;
            border-radius: 0.75rem;
        }
        .tab:hover { color: var(--primary-accent-color); background: var(--sidebar-hover-bg); }
        .tab.tab-active-text { color: var(--primary-accent-color) !important; font-weight: 700; }

        #active-tab-underline {
            position: absolute;
            bottom: 0;
            height: 3px;
            background-color: var(--primary-accent-color);
            border-radius: 2px;
            box-shadow: 0 0 10px 1px var(--glow-color);
            transition: left 0.3s cubic-bezier(0.65, 0, 0.35, 1), width 0.3s cubic-bezier(0.65, 0, 0.35, 1);
            z-index: 0;
        }

        /* ===== Theme Toggle ===== */
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 44px; margin-left: 1rem; }
        .theme-switch input { display: none; }
        .slider {
            background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0;
            transition: .4s; border-radius: 24px;
            box-shadow: 0 0 5px 0px var(--glow-color);
        }
        html.dark .slider { background-color: #333; }
        .slider:before {
            background-color: var(--bg-color);
            bottom: 3px; content: ""; height: 18px; left: 3px; position: absolute;
            transition: .4s; width: 18px; border-radius: 50%;
            box-shadow: 0 0 5px 1px var(--glow-color-intense);
        }
        input:checked + .slider { background-color: var(--primary-accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* ===== Wiki Layout ===== */
        .wiki-layout {
            display: flex;
            gap: 1.5rem;
            min-height: calc(100vh - 180px);
            align-items: flex-start;
        }

        .wiki-sidebar {
            width: 300px;
            flex-shrink: 0;
            position: sticky;
            top: 80px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            padding: 1.25rem;
        }

        .wiki-content-wrapper {
            flex: 1;
            min-width: 0;
        }

        /* ===== Sidebar Styles ===== */
        .sidebar-header {
            padding: 0.25rem 0.5rem 1rem;
            border-bottom: 1px solid var(--card-border-color);
            margin-bottom: 1rem;
        }

        .category-section { margin-bottom: 0.5rem; }

        .category-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.7rem 0.75rem;
            border-radius: 0.75rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-color);
            transition: background 0.2s ease;
            user-select: none;
        }
        .category-header:hover { background: var(--sidebar-hover-bg); }

        .category-chevron {
            transition: transform 0.25s ease;
            font-size: 0.7rem;
            opacity: 0.5;
            margin-left: auto;
        }
        .category-header.collapsed .category-chevron { transform: rotate(-90deg); }

        .category-articles {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.25s ease;
            max-height: 600px;
            opacity: 1;
        }
        .category-articles.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .sidebar-article {
            display: block;
            padding: 0.55rem 0.75rem 0.55rem 2.25rem;
            border-radius: 0.6rem;
            cursor: pointer;
            font-size: 0.88rem;
            color: var(--text-muted-color);
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            margin: 1px 0;
            text-decoration: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .sidebar-article:hover {
            background: var(--sidebar-hover-bg);
            color: var(--text-color);
        }
        .sidebar-article.active {
            background: var(--sidebar-active-bg);
            color: var(--primary-accent-color);
            font-weight: 600;
            border-left-color: var(--primary-accent-color);
        }

        /* ===== Wiki Content Card ===== */
        .wiki-content-card {
            padding: 2rem 2.5rem;
            min-height: 500px;
        }

        .article-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
        }

        .article-category-badge {
            display: inline-block;
            padding: 0.25rem 0.85rem;
            border-radius: 999px;
            font-size: 0.78rem;
            font-weight: 600;
            background: var(--card-bg-color);
            border: 1px solid var(--card-border-color);
            letter-spacing: 0.02em;
        }

        .article-date {
            font-size: 0.8rem;
            color: var(--text-muted-color);
        }

        /* ===== Wiki Welcome View ===== */
        .wiki-welcome { text-align: center; padding: 3rem 1rem; }
        .wiki-welcome h2 { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
        .wiki-welcome p { color: var(--text-muted-color); margin-bottom: 2.5rem; font-size: 1.05rem; }

        .category-card {
            padding: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-align: left;
        }
        .category-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow-color-light);
        }
        .category-card h3 { font-size: 1.15rem; font-weight: 600; margin-bottom: 0.3rem; }
        .category-card .card-count { font-size: 0.85rem; color: var(--text-muted-color); }

        /* ===== Markdown Content (wiki-viewer) ===== */
        .wiki-viewer { color: var(--text-color); line-height: 1.8; }
        .wiki-viewer > *:first-child { margin-top: 0; }
        .wiki-viewer > *:last-child { margin-bottom: 0; }

        .wiki-viewer h1, .wiki-viewer h2, .wiki-viewer h3,
        .wiki-viewer h4, .wiki-viewer h5, .wiki-viewer h6 {
            font-weight: 600;
            margin-top: 1.6em;
            margin-bottom: 0.7em;
            line-height: 1.35;
            color: var(--text-color);
        }
        .wiki-viewer h1 { font-size: 1.9em; }
        .wiki-viewer h2 { font-size: 1.5em; border-bottom: 1px solid var(--card-border-color); padding-bottom: 0.3em; }
        .wiki-viewer h3 { font-size: 1.25em; }
        .wiki-viewer h4 { font-size: 1.1em; }

        .wiki-viewer p { margin-bottom: 1em; }
        .wiki-viewer a { color: var(--primary-accent-color); text-decoration: underline; text-underline-offset: 2px; }
        .wiki-viewer a:hover { opacity: 0.75; }

        .wiki-viewer pre {
            background-color: var(--pre-bg-color);
            color: var(--pre-text-color);
            padding: 1.15em;
            border-radius: 0.75rem;
            overflow-x: auto;
            font-family: 'Fira Code', Consolas, 'Courier New', monospace;
            font-size: 0.88em;
            line-height: 1.55;
            margin: 1.2em 0;
            border: 1px solid var(--card-border-color);
        }
        .wiki-viewer code:not(pre code) {
            font-family: 'Fira Code', Consolas, 'Courier New', monospace;
            background-color: var(--pre-bg-color);
            color: var(--pre-text-color);
            padding: 0.15em 0.4em;
            border-radius: 0.35rem;
            font-size: 0.88em;
        }
        .wiki-viewer pre code {
            background: none;
            padding: 0;
            border-radius: 0;
            font-size: inherit;
        }

        .wiki-viewer ul, .wiki-viewer ol {
            margin-left: 0;
            padding-left: 1.75em;
            margin-bottom: 1em;
        }
        .wiki-viewer li { margin-bottom: 0.4em; }
        .wiki-viewer li > p:first-child { margin-top: 0; }
        .wiki-viewer li > p:last-child { margin-bottom: 0; }
        .wiki-viewer ul { list-style-type: disc; }
        .wiki-viewer ol { list-style-type: decimal; }
        .wiki-viewer ul ul, .wiki-viewer ol ol,
        .wiki-viewer ul ol, .wiki-viewer ol ul {
            margin-left: 1.5em;
            margin-top: 0.3em;
            margin-bottom: 0.3em;
        }

        .wiki-viewer blockquote {
            border-left: 4px solid var(--primary-accent-color);
            padding: 0.5em 1em;
            margin: 1em 0;
            border-radius: 0 0.5rem 0.5rem 0;
            background: var(--sidebar-hover-bg);
            color: var(--text-muted-color);
        }
        .wiki-viewer blockquote p { margin-bottom: 0.3em; }

        .wiki-viewer hr {
            border: 0;
            height: 1px;
            background-color: var(--card-border-color);
            margin: 2em 0;
        }

        .wiki-viewer table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 1.2em 0;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid var(--card-border-color);
        }
        .wiki-viewer th, .wiki-viewer td {
            padding: 0.65em 1em;
            text-align: left;
            border-bottom: 1px solid var(--card-border-color);
        }
        .wiki-viewer th {
            background: var(--sidebar-hover-bg);
            font-weight: 600;
            font-size: 0.9em;
        }
        .wiki-viewer tr:last-child td { border-bottom: none; }

        .wiki-viewer img {
            max-width: 100%;
            border-radius: 0.75rem;
            margin: 1em 0;
        }

        .wiki-viewer mark {
            background: rgba(255, 213, 0, 0.3);
            padding: 0.1em 0.25em;
            border-radius: 0.25rem;
        }
        html.dark .wiki-viewer mark { background: rgba(255, 213, 0, 0.18); }

        .wiki-viewer input[type="checkbox"] {
            margin-right: 0.4em;
            pointer-events: none;
        }

        /* ===== Callouts (Obsidian-style) ===== */
        .callout {
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            margin: 1.2em 0;
            border-left: 4px solid;
        }
        .callout-header {
            font-weight: 600;
            margin-bottom: 0.4rem;
            font-size: 0.95em;
        }
        .callout-body { font-size: 0.93em; }
        .callout-body p:last-child { margin-bottom: 0; }

        .callout-note, .callout-info {
            border-color: var(--callout-note);
            background: rgba(68, 138, 255, 0.07);
        }
        .callout-note .callout-header, .callout-info .callout-header { color: var(--callout-note); }

        .callout-tip, .callout-hint {
            border-color: var(--callout-tip);
            background: rgba(0, 200, 83, 0.07);
        }
        .callout-tip .callout-header, .callout-hint .callout-header { color: var(--callout-tip); }

        .callout-warning, .callout-caution, .callout-attention {
            border-color: var(--callout-warning);
            background: rgba(255, 145, 0, 0.07);
        }
        .callout-warning .callout-header, .callout-caution .callout-header,
        .callout-attention .callout-header { color: var(--callout-warning); }

        .callout-danger, .callout-important, .callout-error {
            border-color: var(--callout-danger);
            background: rgba(255, 23, 68, 0.07);
        }
        .callout-danger .callout-header, .callout-important .callout-header,
        .callout-error .callout-header { color: var(--callout-danger); }

        .callout-example, .callout-abstract, .callout-summary {
            border-color: var(--callout-example);
            background: rgba(124, 77, 255, 0.07);
        }
        .callout-example .callout-header, .callout-abstract .callout-header,
        .callout-summary .callout-header { color: var(--callout-example); }

        .callout-quote {
            border-color: var(--text-muted-color);
            background: var(--sidebar-hover-bg);
        }
        .callout-quote .callout-header { color: var(--text-muted-color); }

        /* ===== MathJax ===== */
        mjx-container {
            display: inline-block;
            line-height: 0;
            text-align: left;
            vertical-align: baseline;
            margin: 0 0.1em;
        }
        mjx-container[display="true"] {
            display: block;
            overflow-x: auto;
            overflow-y: hidden;
            margin: 1em 0;
            line-height: normal;
            text-align: center;
        }

        /* ===== Scrollbar ===== */
        .wiki-sidebar::-webkit-scrollbar { width: 5px; }
        .wiki-sidebar::-webkit-scrollbar-thumb { background: var(--text-muted-color); border-radius: 3px; opacity: 0.4; }
        .wiki-sidebar::-webkit-scrollbar-track { background: transparent; }

        /* ===== Mobile Sidebar ===== */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            z-index: 90;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .sidebar-overlay.open { display: block; opacity: 1; }

        #mobileSidebarToggle { display: none; }

        @media (max-width: 768px) {
            .wiki-layout { flex-direction: column; }

            .wiki-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 300px;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                border-radius: 0 1rem 1rem 0;
                max-height: 100vh;
            }
            .wiki-sidebar.open { transform: translateX(0); }

            #mobileSidebarToggle {
                display: flex;
                position: fixed;
                bottom: 1.5rem;
                right: 1.5rem;
                z-index: 80;
                width: 3.5rem;
                height: 3.5rem;
                border-radius: 1rem;
                align-items: center;
                justify-content: center;
                border: none;
                cursor: pointer;
                background: var(--primary-accent-color);
                color: var(--bg-color);
                box-shadow: 0 4px 15px var(--shadow-color-light);
                transition: transform 0.2s ease;
            }
            #mobileSidebarToggle:active { transform: scale(0.92); }

            .wiki-content-card { padding: 1.25rem; }
        }

        /* ===== Animation ===== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease forwards; }

        .content-section { display: none; }
        .content-section.visible { display: block; }
    </style>
</head>
<body>
    <header class="header-frosted sticky top-0 z-40">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <h1 id="userName" class="text-2xl sm:text-3xl font-bold" style="color: var(--primary-accent-color);"></h1>
            <nav class="main-nav flex items-center relative">
                <button onclick="navigate('home', this)" class="tab" data-tab="home">Home</button>
                <button onclick="navigate('wiki', this)" class="tab" data-tab="wiki">Wiki</button>
                <span id="active-tab-underline"></span>
                <div class="theme-switch-wrapper ml-3">
                    <label class="theme-switch" for="themeToggleCheckbox">
                        <input type="checkbox" id="themeToggleCheckbox" />
                        <span class="slider"></span>
                    </label>
                </div>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 py-6">
        <section id="home" class="content-section">
            <div class="frosted-glass p-6 sm:p-8 fade-in">
                <h2 class="text-2xl sm:text-3xl font-semibold mb-6">About Me</h2>
                <div id="personalInfoContent" class="space-y-4"></div>
            </div>
        </section>

        <section id="wiki" class="content-section">
            <button id="mobileSidebarToggle" onclick="toggleMobileSidebar()">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            </button>
            <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

            <div class="wiki-layout">
                <aside id="wikiSidebar" class="wiki-sidebar frosted-glass">
                    <div class="sidebar-header">
                        <h2 class="text-xl font-bold" style="color: var(--primary-accent-color);">Wiki</h2>
                    </div>
                    <div id="sidebarContent"></div>
                </aside>

                <div class="wiki-content-wrapper">
                    <div id="wikiContent" class="wiki-content-card frosted-glass fade-in">
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="text-center py-8 text-sm" style="color: var(--text-muted-color);">
        <p>&copy; <span id="currentYear"></span> <span id="footerName"></span>. All rights reserved.</p>
    </footer>

    <script>
        let siteConfig = {
            userName: "Leo Xu",
            footerName: "Leo Xu",
            personalInfoHTML: "<p>Welcome to my personal page!</p>"
        };

        let wikiData = { categories: [] };
        let activeArticleId = null;
        let expandedCategories = new Set();

        const themeToggle = document.getElementById('themeToggleCheckbox');
        const htmlEl = document.documentElement;

        // ===== Initialization =====
        async function initializeApp() {
            initializeTheme();
            await loadSiteConfig();
            await loadWikiManifest();
            configureMarked();

            document.getElementById('currentYear').textContent = new Date().getFullYear();
            themeToggle.addEventListener('change', toggleTheme);

            handleRoute();
            window.addEventListener('hashchange', handleRoute);
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

        // ===== Theme =====
        function initializeTheme() {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark') {
                htmlEl.classList.add('dark');
                themeToggle.checked = true;
                updateCodeTheme(true);
            } else {
                htmlEl.classList.remove('dark');
                themeToggle.checked = false;
                updateCodeTheme(false);
            }
        }

        function toggleTheme() {
            const isDark = themeToggle.checked;
            htmlEl.classList.toggle('dark', isDark);
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateCodeTheme(isDark);
        }

        function updateCodeTheme(isDark) {
            document.getElementById('hljs-light').disabled = isDark;
            document.getElementById('hljs-dark').disabled = !isDark;
        }

        // ===== Config Loading =====
        async function loadSiteConfig() {
            try {
                const resp = await fetch('config.json');
                if (resp.ok) {
                    const cfg = await resp.json();
                    siteConfig = { ...siteConfig, ...cfg };
                }
            } catch (e) { console.warn('Could not load config.json', e); }

            document.getElementById('userName').textContent = siteConfig.userName;
            document.getElementById('footerName').textContent = siteConfig.footerName;
            document.getElementById('personalInfoContent').innerHTML = siteConfig.personalInfoHTML;
        }

        // ===== Wiki Manifest =====
        async function loadWikiManifest() {
            try {
                const resp = await fetch('wiki_manifest.json');
                if (resp.ok) {
                    wikiData = await resp.json();
                    wikiData.categories.forEach(c => expandedCategories.add(c.id));
                }
            } catch (e) { console.warn('Could not load wiki_manifest.json', e); }
        }

        // ===== Marked.js Config =====
        function configureMarked() {
            marked.use({
                breaks: true,
                gfm: true,
                renderer: {
                    code({ text, lang }) {
                        const language = lang && hljs.getLanguage(lang) ? lang : null;
                        let highlighted;
                        try {
                            highlighted = language
                                ? hljs.highlight(text, { language }).value
                                : hljs.highlightAuto(text).value;
                        } catch (e) {
                            highlighted = text;
                        }
                        return `<pre><code class="hljs${language ? ' language-' + language : ''}">${highlighted}</code></pre>`;
                    }
                }
            });
        }

        // ===== Routing =====
        function handleRoute() {
            const hash = window.location.hash.slice(1);
            if (hash.startsWith('wiki/')) {
                const articleId = hash.slice(5);
                showSection('wiki');
                selectArticle(articleId);
            } else if (hash === 'wiki') {
                showSection('wiki');
                showWikiWelcome();
            } else {
                showSection('home');
            }
        }

        function navigate(section, tabEl) {
            if (section === 'wiki') {
                window.location.hash = activeArticleId ? `wiki/${activeArticleId}` : 'wiki';
            } else {
                window.location.hash = '';
            }
        }

        // ===== Section Display =====
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('visible'));
            const section = document.getElementById(sectionId);
            if (section) section.classList.add('visible');

            const tabEl = document.querySelector(`.tab[data-tab="${sectionId}"]`);
            updateActiveTab(tabEl);

            if (sectionId === 'wiki') {
                renderSidebar();
                if (!activeArticleId) showWikiWelcome();
            }
        }

        function updateActiveTab(tabEl) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active-text'));
            const underline = document.getElementById('active-tab-underline');
            if (tabEl) {
                tabEl.classList.add('tab-active-text');
                underline.style.left = tabEl.offsetLeft + 'px';
                underline.style.width = tabEl.offsetWidth + 'px';
            } else {
                underline.style.width = '0px';
            }
        }

        // ===== Sidebar =====
        function renderSidebar() {
            const container = document.getElementById('sidebarContent');
            container.innerHTML = '';

            if (wikiData.categories.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted-color); padding: 0.5rem; font-size: 0.9rem;">No categories yet. Add entries to wiki_manifest.json.</p>';
                return;
            }

            wikiData.categories.forEach(cat => {
                const section = document.createElement('div');
                section.className = 'category-section';

                const isExpanded = expandedCategories.has(cat.id);

                const header = document.createElement('div');
                header.className = `category-header${isExpanded ? '' : ' collapsed'}`;
                header.innerHTML = `
                    <span>${cat.name}</span>
                    <span class="category-chevron">&#9662;</span>
                `;
                header.onclick = () => toggleCategory(cat.id);
                section.appendChild(header);

                const articlesList = document.createElement('div');
                articlesList.className = `category-articles${isExpanded ? '' : ' collapsed'}`;
                articlesList.id = `cat-articles-${cat.id}`;

                if (cat.articles && cat.articles.length > 0) {
                    cat.articles.forEach(article => {
                        const item = document.createElement('div');
                        item.className = `sidebar-article${activeArticleId === article.id ? ' active' : ''}`;
                        item.textContent = article.title;
                        item.onclick = (e) => {
                            e.stopPropagation();
                            window.location.hash = `wiki/${article.id}`;
                            closeMobileSidebar();
                        };
                        articlesList.appendChild(item);
                    });
                } else {
                    const empty = document.createElement('div');
                    empty.style.cssText = 'padding: 0.4rem 0.75rem 0.4rem 2.25rem; font-size: 0.82rem; color: var(--text-muted-color); font-style: italic;';
                    empty.textContent = 'No articles yet';
                    articlesList.appendChild(empty);
                }

                section.appendChild(articlesList);
                container.appendChild(section);
            });
        }

        function toggleCategory(catId) {
            if (expandedCategories.has(catId)) {
                expandedCategories.delete(catId);
            } else {
                expandedCategories.add(catId);
            }
            renderSidebar();
        }

        // ===== Wiki Welcome =====
        function showWikiWelcome() {
            const content = document.getElementById('wikiContent');
            let cardsHtml = '';

            wikiData.categories.forEach(cat => {
                const count = cat.articles ? cat.articles.length : 0;
                const firstArticleId = count > 0 ? cat.articles[0].id : null;
                const onclick = firstArticleId
                    ? `onclick="window.location.hash='wiki/${firstArticleId}'"`
                    : '';
                cardsHtml += `
                    <div class="category-card frosted-glass" ${onclick}>
                        <h3>${cat.name}</h3>
                        <p class="card-count">${count} article${count !== 1 ? 's' : ''}</p>
                    </div>`;
            });

            content.innerHTML = `
                <div class="wiki-welcome fade-in">
                    <h2>Wiki</h2>
                    <p>Browse categories or select an article from the sidebar.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${cardsHtml || '<p style="color: var(--text-muted-color);">No categories yet.</p>'}
                    </div>
                </div>`;
        }

        // ===== Select & Render Article =====
        function findArticle(articleId) {
            for (const cat of wikiData.categories) {
                if (cat.articles) {
                    const found = cat.articles.find(a => a.id === articleId);
                    if (found) return { article: found, category: cat };
                }
            }
            return null;
        }

        async function selectArticle(articleId) {
            const result = findArticle(articleId);
            if (!result) {
                document.getElementById('wikiContent').innerHTML = `
                    <div class="wiki-welcome">
                        <h2>Article Not Found</h2>
                        <p>The article you're looking for doesn't exist.</p>
                    </div>`;
                return;
            }

            const { article, category } = result;
            activeArticleId = articleId;

            if (!expandedCategories.has(category.id)) {
                expandedCategories.add(category.id);
            }
            renderSidebar();

            const contentEl = document.getElementById('wikiContent');
            contentEl.innerHTML = '<p style="color: var(--text-muted-color); font-style: italic; padding: 2rem;">Loading...</p>';

            let rawMarkdown = '';
            if (article.path) {
                try {
                    const resp = await fetch(article.path);
                    if (resp.ok) {
                        rawMarkdown = await resp.text();
                    } else {
                        rawMarkdown = `# Error\n\nCould not load: \`${article.path}\`\nStatus: ${resp.status}`;
                    }
                } catch (e) {
                    rawMarkdown = `# Error\n\nFailed to fetch: \`${article.path}\`\n\n${e}`;
                }
            } else {
                rawMarkdown = article.content || '# Empty Article\n\nNo content available.';
            }

            const html = renderMarkdown(rawMarkdown);

            const metaHtml = `
                <div class="article-meta">
                    <span class="article-category-badge">${category.name}</span>
                    ${article.date ? `<span class="article-date">${formatDate(article.date)}</span>` : ''}
                </div>`;

            contentEl.innerHTML = `<div class="fade-in">${metaHtml}<div class="wiki-viewer">${html}</div></div>`;

            await typesetMath(contentEl);
        }

        function formatDate(dateStr) {
            try {
                const d = new Date(dateStr + 'T00:00:00');
                return d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            } catch { return dateStr; }
        }

        // ===== Markdown Rendering with Obsidian Compatibility =====
        function renderMarkdown(raw) {
            const mathBlocks = [];
            let mathIdx = 0;

            function extractMath(text) {
                text = text.replace(/\$\$([\s\S]*?)\$\$/g, (match) => {
                    const key = `\u{E000}DM${mathIdx}\u{E000}`;
                    mathBlocks.push({ key, value: match });
                    mathIdx++;
                    return key;
                });
                text = text.replace(/(?<!\$)\$(?!\$)([^\$\n]+?)\$(?!\$)/g, (match) => {
                    const key = `\u{E000}IM${mathIdx}\u{E000}`;
                    mathBlocks.push({ key, value: match });
                    mathIdx++;
                    return key;
                });
                return text;
            }

            function processHighlights(text) {
                return text.replace(/==(.*?)==/g, '<mark>$1</mark>');
            }

            let processed = processOutsideCode(raw, (text) => {
                text = extractMath(text);
                text = processHighlights(text);
                return text;
            });

            let html = marked.parse(processed);
            html = processCallouts(html);

            mathBlocks.forEach(({ key, value }) => {
                html = html.split(key).join(value);
            });

            return html;
        }

        function processOutsideCode(markdown, processor) {
            const parts = markdown.split(/(```[\s\S]*?```|`[^`\n]+`)/g);
            return parts.map(part => {
                if ((part.startsWith('```') && part.endsWith('```')) ||
                    (part.startsWith('`') && part.endsWith('`') && part.length > 1 && !part.startsWith('```'))) {
                    return part;
                }
                return processor(part);
            }).join('');
        }

        function processCallouts(html) {
            return html.replace(
                /<blockquote>([\s\S]*?)<\/blockquote>/g,
                (match, inner) => {
                    const calloutMatch = inner.match(/^\s*<p>\s*\[!([\w-]+)\]\s*([\s\S]*)/);
                    if (!calloutMatch) return match;

                    const type = calloutMatch[1].toLowerCase();
                    let rest = calloutMatch[2];

                    let title = type.charAt(0).toUpperCase() + type.slice(1);
                    const titleMatch = rest.match(/^([^\n<]*?)(?:<br\s*\/?>|<\/p>)([\s\S]*)/);
                    if (titleMatch) {
                        if (titleMatch[1].trim()) title = titleMatch[1].trim();
                        rest = titleMatch[2];
                    } else {
                        const singleLine = rest.replace(/<\/p>\s*$/, '').trim();
                        if (singleLine) title = singleLine;
                        rest = '';
                    }

                    rest = rest.replace(/^\s*<p>/, '').replace(/<\/p>\s*$/, '');

                    return `<div class="callout callout-${type}">
                        <div class="callout-header">${title}</div>
                        ${rest.trim() ? `<div class="callout-body"><p>${rest}</p></div>` : ''}
                    </div>`;
                }
            );
        }

        // ===== MathJax Typesetting =====
        async function typesetMath(element) {
            if (window.MathJax) {
                if (MathJax.typesetPromise) {
                    try {
                        MathJax.typesetClear([element]);
                        await MathJax.typesetPromise([element]);
                    } catch (e) { console.warn('MathJax typesetting error:', e); }
                }
            }
        }

        // ===== Mobile Sidebar =====
        function toggleMobileSidebar() {
            document.getElementById('wikiSidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('open');
        }

        function closeMobileSidebar() {
            document.getElementById('wikiSidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('open');
        }
    </script>
</body>
</html>
